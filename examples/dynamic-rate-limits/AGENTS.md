# Agent Instructions: Dynamic Rate Limiting

This file provides instructions for AI agents working with this Zuplo example.

## Before You Start

**Critical**: This example requires human interaction with the Zuplo Portal for initial setup. Agents cannot complete the full setup autonomously.

## Setup Workflow

### Phase 1: Agent-Executable (Automated)

Run these commands to prepare the local environment:

```bash
# 1. Install dependencies
npm install
```

### Phase 2: Human-Required (Portal Access)

**Stop and inform the user** they must complete these steps in the [Zuplo Portal](https://portal.zuplo.com):

1. **Create/select a Zuplo project**
2. **Configure API Key Service**: Services → API Key Service → Configure
3. **Create two API key consumers**:
   - Consumer 1: Name "Premium User", Metadata: `{"customerType": "premium"}`
   - Consumer 2: Name "Free User", Metadata: `{"customerType": "free"}`
4. **Copy both API keys** for testing

### Phase 3: Link Local Environment (Interactive)

The user must run this command and complete the interactive prompts:

```bash
npx zuplo link
```

This creates `.env.zuplo` which connects to Zuplo's API Key Service and Rate Limiting Service.

### Phase 4: Agent-Executable (Development)

Once linked, agents can:

```bash
# Start dev server
npm run dev

# Test with user-provided API keys
curl -i http://localhost:9000/todos -H "Authorization: Bearer <PREMIUM_KEY>"
curl -i http://localhost:9000/todos -H "Authorization: Bearer <FREE_KEY>"
```

## File Modification Guidelines

### Safe to Modify

| File | Purpose | Notes |
|------|---------|-------|
| `modules/dynamic-rate-limiter.ts` | Rate limit logic | Add new tiers, change limits |
| `config/routes.oas.json` | API routes | Add/modify endpoints, change handlers |
| `config/policies.json` | Policy config | Add new policies, reorder policy chains |

### Do Not Modify

| File | Reason |
|------|--------|
| `.env.zuplo` | Generated by `zuplo link`, contains auth tokens |
| `zuplo.jsonc` | Project metadata, rarely needs changes |

## Code Patterns

### Adding a Route with Rate Limiting

```json
// In config/routes.oas.json under "paths"
"/endpoint": {
  "get": {
    "operationId": "operation-name",
    "x-zuplo-route": {
      "handler": {
        "export": "urlForwardHandler",
        "module": "$import(@zuplo/runtime)",
        "options": {
          "baseUrl": "https://backend.example.com"
        }
      },
      "policies": {
        "inbound": ["api-key-inbound", "rate-limit-inbound"]
      }
    }
  }
}
```

### Adding a Customer Tier

```typescript
// In modules/dynamic-rate-limiter.ts
if (user.data.customerType === "enterprise") {
  return {
    key: user.sub,
    requestsAllowed: 10000,
    timeWindowMinutes: 1,
  };
}
```

Remember to create an API key in the portal with metadata `{"customerType": "enterprise"}`.

### Adding a Policy

```json
// In config/policies.json under "policies" array
{
  "name": "my-policy",
  "policyType": "custom-code-inbound",
  "handler": {
    "export": "default",
    "module": "$import(./modules/my-policy)"
  }
}
```

## Testing Commands

```bash
# Get all todos (premium - expect ratelimit-limit: 1000)
curl -i http://localhost:9000/todos \
  -H "Authorization: Bearer <PREMIUM_KEY>"

# Get all todos (free - expect ratelimit-limit: 5)
curl -i http://localhost:9000/todos \
  -H "Authorization: Bearer <FREE_KEY>"

# Create todo
curl -i -X POST http://localhost:9000/todos \
  -H "Authorization: Bearer <API_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"title": "Test todo", "userId": 1}'

# Update todo
curl -i -X PUT http://localhost:9000/todos/1 \
  -H "Authorization: Bearer <API_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"completed": true}'

# Delete todo
curl -i -X DELETE http://localhost:9000/todos/1 \
  -H "Authorization: Bearer <API_KEY>"

# Test rate limit exhaustion (free tier)
for i in {1..6}; do
  curl -s -o /dev/null -w "%{http_code}\n" http://localhost:9000/todos \
    -H "Authorization: Bearer <FREE_KEY>"
done
```

## Deployment

After all changes are complete and tested:

```bash
zuplo deploy
```

## Common Issues

| Symptom | Likely Cause | Agent Action |
|---------|--------------|--------------|
| `401 Unauthorized` | Bad API key | Ask user to verify API key |
| `429 Too Many Requests` | Rate limit exceeded | This is expected behavior; wait for reset |
| Wrong rate limit in headers | Missing metadata | Ask user to check API key metadata in portal |
| `ECONNREFUSED` | Server not running | Run `npm run dev` |
| API Key Service error | Not linked | Ask user to run `npx zuplo link` |

## User Communication Templates

### Initial Setup Message

> To use this example, you'll need to complete some setup in the Zuplo Portal:
>
> 1. Go to [portal.zuplo.com](https://portal.zuplo.com)
> 2. Create or select a project
> 3. Navigate to **Services → API Key Service** and click **Configure**
> 4. Create two API key consumers with these metadata values:
>    - Premium: `{"customerType": "premium"}` (1000 requests/minute)
>    - Free: `{"customerType": "free"}` (5 requests/minute)
> 5. Copy both API keys
> 6. Run `npx zuplo link` and follow the prompts
>
> Let me know when you've completed these steps and I'll help you test the API.

### Ready to Test Message

> The setup is complete. You can now test the rate limiting:
>
> ```bash
> # Test premium tier (check ratelimit-limit header shows 1000)
> curl -i http://localhost:9000/todos -H "Authorization: Bearer YOUR_PREMIUM_KEY"
>
> # Test free tier (check ratelimit-limit header shows 5)
> curl -i http://localhost:9000/todos -H "Authorization: Bearer YOUR_FREE_KEY"
> ```
>
> The `-i` flag shows response headers where you can verify the rate limit values.
