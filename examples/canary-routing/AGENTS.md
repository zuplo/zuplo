# Agent Instructions: Canary Routing

This file provides instructions for AI agents working with this Zuplo example.

## Before You Start

**Critical**: This example requires human interaction with the Zuplo Portal for initial setup. Agents cannot complete the full setup autonomously.

## Setup Workflow

### Phase 1: Agent-Executable (Automated)

Run these commands to prepare the local environment:

```bash
# 1. Install dependencies
npm install

# 2. Create environment file from template
cp env.example .env
```

The `.env` file includes working mock backend URLs by default.

### Phase 2: Human-Required (Portal Access)

**Stop and inform the user** they must complete these steps in the [Zuplo Portal](https://portal.zuplo.com):

1. **Create/select a Zuplo project**
2. **Configure API Key Service**: Services → API Key Service → Configure
3. **Create at least one API key consumer** (e.g., name it `test-user`)
4. **Copy the API key** for testing

### Phase 3: Link Local Environment (Interactive)

The user must run this command and complete the interactive prompts:

```bash
npx zuplo link
```

This creates `.env.zuplo` which connects to Zuplo's API Key Service.

### Phase 4: Agent-Executable (Development)

Once linked, agents can:

```bash
# Start dev server
npm run dev

# Test routing to production (default)
curl http://localhost:9000/v1/balance -H "Authorization: Bearer <API_KEY>"

# Test routing to canary via header
curl http://localhost:9000/v1/balance -H "Authorization: Bearer <API_KEY>" -H "x-stage: canary"
```

## File Modification Guidelines

### Safe to Modify

| File | Purpose | Notes |
|------|---------|-------|
| `modules/canary-routing.ts` | Routing logic | Add routing conditions, modify priority |
| `config/routes.oas.json` | API routes | Add/modify endpoints, change handlers |
| `config/policies.json` | Policy config | Add new policies, reorder policy chains |
| `.env` | Local env vars | Adjust percentage, add canary users |

### Do Not Modify

| File | Reason |
|------|--------|
| `.env.zuplo` | Generated by `zuplo link`, contains auth tokens |
| `zuplo.jsonc` | Project metadata, rarely needs changes |

## Code Patterns

### Adding a Route

```json
// In config/routes.oas.json under "paths"
"/v1/endpoint": {
  "get": {
    "operationId": "operation-name",
    "x-zuplo-route": {
      "handler": {
        "export": "urlRewriteHandler",
        "module": "$import(@zuplo/runtime)",
        "options": {
          "rewritePattern": "${context.custom.backendUrl}/v1/endpoint"
        }
      },
      "policies": {
        "inbound": ["api-key-auth", "canary-routing"]
      }
    }
  }
}
```

### Adding a Canary User

1. User creates API key consumer in portal with a specific name (e.g., `beta-tester`)
2. Update `.env`:
   ```
   CANARY_USERS=beta-tester
   ```

### Modifying Routing Logic

```typescript
// In modules/canary-routing.ts
// Add new routing condition before percentage-based routing:

// Example: Route based on custom header
const customHeader = request.headers.get("x-canary-group");
if (customHeader === "alpha") {
  return routeToCanary(request, context, "custom-header");
}
```

### Adding a Policy

```json
// In config/policies.json under "policies" array
{
  "name": "my-policy",
  "policyType": "custom-code-inbound",
  "handler": {
    "export": "default",
    "module": "$import(./modules/my-policy)"
  }
}
```

## Testing Commands

```bash
# Route to production (default behavior)
curl http://localhost:9000/v1/balance \
  -H "Authorization: Bearer <API_KEY>"

# Route to canary via explicit header
curl http://localhost:9000/v1/balance \
  -H "Authorization: Bearer <API_KEY>" \
  -H "x-stage: canary"

# Test sticky routing with session ID
curl http://localhost:9000/v1/balance \
  -H "Authorization: Bearer <API_KEY>" \
  -H "x-session-id: session-123"
```

Verify routing by checking `livemode` in response:
- Production: `"livemode": true`
- Canary: `"livemode": false`

## Deployment

After all changes are complete and tested:

```bash
zuplo deploy
```

**Note**: For deployed projects, environment variables must also be set in the Zuplo Portal under Settings → Environment Variables.

## Common Issues

| Symptom | Likely Cause | Agent Action |
|---------|--------------|--------------|
| `401 Unauthorized` | Bad API key | Ask user to verify API key |
| All traffic goes to production | `CANARY_PERCENTAGE=0` | Suggest setting percentage or using `x-stage` header |
| `ECONNREFUSED` | Server not running | Run `npm run dev` |
| `API_URL_CANARY not configured` | Missing env var | Check `.env` file has both backend URLs |
| API Key Service error | Not linked | Ask user to run `npx zuplo link` |
| Canary user not routing | Name mismatch | Verify consumer name matches `CANARY_USERS` exactly |

## User Communication Templates

### Initial Setup Message

> To use this example, you'll need to complete some setup in the Zuplo Portal:
>
> 1. Go to [portal.zuplo.com](https://portal.zuplo.com)
> 2. Create or select a project
> 3. Navigate to **Services → API Key Service** and click **Configure**
> 4. Create an API key consumer (e.g., name it `test-user`)
> 5. Copy the API key
> 6. Run `npx zuplo link` and follow the prompts
>
> Let me know when you've completed these steps and I'll help you test the canary routing.

### Ready to Test Message

> The setup is complete. You can now test the canary routing:
>
> ```bash
> # Test production routing (default)
> curl http://localhost:9000/v1/balance -H "Authorization: Bearer YOUR_API_KEY"
>
> # Test canary routing via header
> curl http://localhost:9000/v1/balance -H "Authorization: Bearer YOUR_API_KEY" -H "x-stage: canary"
> ```
>
> The production response will show `"livemode": true` and the canary response will show `"livemode": false`.

### Canary Users Setup Message

> To add users to the canary allow-list:
>
> 1. Create an API key consumer in the portal with a specific name (e.g., `beta-tester-alice`)
> 2. Add the name to your `.env` file: `CANARY_USERS=beta-tester-alice`
> 3. Restart the dev server
>
> That user will now always be routed to the canary backend, regardless of the percentage setting.
