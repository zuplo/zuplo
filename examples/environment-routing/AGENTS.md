# Agent Instructions: Environment-Based Routing

This file provides instructions for AI agents working with this Zuplo example.

## Before You Start

**Critical**: This example requires human interaction with the Zuplo Portal for initial setup. Agents cannot complete the full setup autonomously.

## Setup Workflow

### Phase 1: Agent-Executable (Automated)

Run these commands to prepare the local environment:

```bash
# 1. Install dependencies
npm install

# 2. Create environment file from template
cp env.example .env
```

The `.env` file will contain working mock backend URLs by default.

### Phase 2: Human-Required (Portal Access)

**Stop and inform the user** they must complete these steps in the [Zuplo Portal](https://portal.zuplo.com):

1. **Create/select a Zuplo project**
2. **Configure API Key Service**: Services → API Key Service → Configure
3. **Create two API key consumers**:
   - Consumer 1: Name "Sandbox User", Metadata: `{"environment": "sandbox"}`
   - Consumer 2: Name "Production User", Metadata: `{"environment": "production"}`
4. **Copy both API keys** for testing

### Phase 3: Link Local Environment (Interactive)

The user must run this command and complete the interactive prompts:

```bash
npx zuplo link
```

This creates `.env.zuplo` which connects to Zuplo's API Key Service.

### Phase 4: Agent-Executable (Development)

Once linked, agents can:

```bash
# Start dev server
npm run dev

# Test with user-provided API keys
curl http://localhost:9000/v1/balance -H "Authorization: Bearer <SANDBOX_KEY>"
curl http://localhost:9000/v1/balance -H "Authorization: Bearer <PRODUCTION_KEY>"
```

## File Modification Guidelines

### Safe to Modify

| File | Purpose | Notes |
|------|---------|-------|
| `modules/environment-routing.ts` | Routing logic | Add new environments, change routing rules |
| `config/routes.oas.json` | API routes | Add/modify endpoints, change handlers |
| `config/policies.json` | Policy config | Add new policies, reorder policy chains |
| `.env` | Local env vars | Add new backend URLs |

### Do Not Modify

| File | Reason |
|------|--------|
| `.env.zuplo` | Generated by `zuplo link`, contains auth tokens |
| `zuplo.jsonc` | Project metadata, rarely needs changes |

## Code Patterns

### Adding a Route

```json
// In config/routes.oas.json under "paths"
"/v1/endpoint": {
  "get": {
    "operationId": "operation-name",
    "x-zuplo-route": {
      "handler": {
        "export": "urlRewriteHandler",
        "module": "$import(@zuplo/runtime)",
        "options": {
          "rewritePattern": "${context.custom.backendUrl}/v1/endpoint"
        }
      },
      "policies": {
        "inbound": ["api-key-auth", "environment-routing"]
      }
    }
  }
}
```

### Adding an Environment

```typescript
// In modules/environment-routing.ts
} else if (userEnvironment === "new-env") {
  context.custom.backendUrl = environment.NEW_ENV_BACKEND_URL;
  context.log.info("Routing to new-env environment");
}
```

Remember to add `NEW_ENV_BACKEND_URL` to `.env`.

### Adding a Policy

```json
// In config/policies.json under "policies" array
{
  "name": "my-policy",
  "policyType": "custom-code-inbound",
  "handler": {
    "export": "default",
    "module": "$import(./modules/my-policy)"
  }
}
```

## Testing Commands

```bash
# Get balance (sandbox)
curl http://localhost:9000/v1/balance \
  -H "Authorization: Bearer <SANDBOX_KEY>"

# Get balance (production)
curl http://localhost:9000/v1/balance \
  -H "Authorization: Bearer <PRODUCTION_KEY>"

# Create charge
curl -X POST http://localhost:9000/v1/charges \
  -H "Authorization: Bearer <API_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"amount": 2000, "currency": "usd"}'

# Get charge by ID
curl http://localhost:9000/v1/charges/ch_123 \
  -H "Authorization: Bearer <API_KEY>"
```

## Deployment

After all changes are complete and tested:

```bash
zuplo deploy
```

**Note**: For deployed projects, environment variables must also be set in the Zuplo Portal under Settings → Environment Variables.

## Common Issues

| Symptom | Likely Cause | Agent Action |
|---------|--------------|--------------|
| `401 Unauthorized` | Bad API key | Ask user to verify API key |
| `403 Forbidden` | Missing metadata | Ask user to check API key metadata in portal |
| `ECONNREFUSED` | Server not running | Run `npm run dev` |
| `*_BACKEND_URL is not defined` | Missing .env | Run `cp env.example .env` |
| API Key Service error | Not linked | Ask user to run `npx zuplo link` |

## User Communication Templates

### Initial Setup Message

> To use this example, you'll need to complete some setup in the Zuplo Portal:
>
> 1. Go to [portal.zuplo.com](https://portal.zuplo.com)
> 2. Create or select a project
> 3. Navigate to **Services → API Key Service** and click **Configure**
> 4. Create two API key consumers with these metadata values:
>    - Sandbox: `{"environment": "sandbox"}`
>    - Production: `{"environment": "production"}`
> 5. Copy both API keys
> 6. Run `npx zuplo link` and follow the prompts
>
> Let me know when you've completed these steps and I'll help you test the API.

### Ready to Test Message

> The setup is complete. You can now test the routing:
>
> ```bash
> # Test sandbox routing
> curl http://localhost:9000/v1/balance -H "Authorization: Bearer YOUR_SANDBOX_KEY"
>
> # Test production routing  
> curl http://localhost:9000/v1/balance -H "Authorization: Bearer YOUR_PRODUCTION_KEY"
> ```
>
> The sandbox response will show `"livemode": false` and the production response will show `"livemode": true`.
