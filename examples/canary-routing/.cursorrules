# Cursor Rules: Canary Routing Example

## Project Context

This is a Zuplo API Gateway example demonstrating percentage-based canary deployments. Requests route to production or canary backends based on user allow-lists, explicit headers, or traffic percentage.

## Key Files

- `modules/canary-routing.ts` - Custom policy that evaluates routing priority (user → header → percentage → default)
- `config/routes.oas.json` - OpenAPI routes using `${context.custom.backendUrl}` for dynamic backend selection
- `config/policies.json` - Defines `api-key-auth` and `canary-routing` policies

## Routing Priority

1. **User Allow-List**: If `request.user.sub` is in `CANARY_USERS`, route to canary
2. **Explicit Header**: If `x-stage: canary` header present, route to canary
3. **Percentage-Based**: If hash of session/IP < `CANARY_PERCENTAGE`, route to canary
4. **Default**: Route to production

## Human vs Agent Tasks

### Requires Human (Cannot Automate)

- Creating Zuplo account/project
- Configuring API Key Service in portal
- Creating API key consumers
- Running `npx zuplo link` (interactive authentication)
- Setting environment variables in Zuplo Portal (for deployed projects)

### Agent Can Automate

- `npm install` - Install dependencies
- `cp env.example .env` - Create environment file
- `npm run dev` - Start development server
- `zuplo deploy` - Deploy to Zuplo (after setup complete)
- Editing any code files
- Testing with curl commands (once user provides API keys)

## Code Conventions

### Route Definition Pattern

```json
"/v1/endpoint": {
  "get": {
    "operationId": "descriptive-operation-name",
    "x-zuplo-route": {
      "handler": {
        "export": "urlRewriteHandler",
        "module": "$import(@zuplo/runtime)",
        "options": {
          "rewritePattern": "${context.custom.backendUrl}/v1/endpoint"
        }
      },
      "policies": {
        "inbound": ["api-key-auth", "canary-routing"]
      }
    }
  }
}
```

### Policy Pattern

```typescript
import { ZuploContext, ZuploRequest, environment } from "@zuplo/runtime";

export default async function policy(
  request: ZuploRequest,
  context: ZuploContext,
) {
  // Access user data from API key authentication
  const userId = request.user?.sub;
  
  // Set custom context for downstream handlers
  context.custom.backendUrl = environment.API_URL_PRODUCTION;
  
  // Return request to continue, or Response to short-circuit
  return request;
}
```

### Environment Variable Access

```typescript
import { environment } from "@zuplo/runtime";

// Access environment variables
const productionUrl = environment.API_URL_PRODUCTION;
const canaryUrl = environment.API_URL_CANARY;
const percentage = parseInt(environment.CANARY_PERCENTAGE || "0", 10);
const canaryUsers = environment.CANARY_USERS?.split(",") || [];
```

## When User Asks to Set Up

1. Run `npm install`
2. Run `cp env.example .env`
3. **Inform user** they must complete portal setup:
   - Configure API Key Service
   - Create at least one API key consumer
   - Run `npx zuplo link` interactively
4. After user confirms setup, run `npm run dev`
5. Test with user-provided API keys

## Adding New Functionality

### New Route

1. Add path object to `config/routes.oas.json` under `paths`
2. Use `urlRewriteHandler` with `${context.custom.backendUrl}` prefix
3. Include `["api-key-auth", "canary-routing"]` in inbound policies

### Adjust Canary Percentage

Update `.env`:
```
CANARY_PERCENTAGE=25
```

### Add Canary Users

1. User creates API key consumer in portal (e.g., `beta-tester`)
2. Add to `.env`:
   ```
   CANARY_USERS=beta-tester,another-tester
   ```

### New Policy

1. Create file in `modules/` directory
2. Add policy definition to `config/policies.json`
3. Reference policy name in route's `policies.inbound` array

## Testing

Dev server runs on `http://localhost:9000`. Test commands:

```bash
# Production routing (default)
curl http://localhost:9000/v1/balance -H "Authorization: Bearer <KEY>"

# Canary routing via header
curl http://localhost:9000/v1/balance -H "Authorization: Bearer <KEY>" -H "x-stage: canary"

# Test sticky routing
curl http://localhost:9000/v1/balance -H "Authorization: Bearer <KEY>" -H "x-session-id: test-123"
```

Verify routing by checking `livemode` field:
- Production: `"livemode": true`
- Canary: `"livemode": false`

## Error Handling

| Error | Meaning |
|-------|---------|
| 401 | Invalid or missing API key |
| `API_URL_CANARY not configured` | Missing canary URL in .env |
| All traffic to production | `CANARY_PERCENTAGE=0` or not set |
| Canary user not routing | Consumer name doesn't match `CANARY_USERS` |

## Do Not

- Commit `.env` or `.env.zuplo` files
- Modify `zuplo.jsonc` without clear reason
- Skip the `api-key-auth` policy on routes that need canary routing
- Use hardcoded backend URLs instead of environment variables
- Assume `request.user` exists without optional chaining (use `request.user?.sub`)
