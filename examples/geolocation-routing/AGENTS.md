# Agent Instructions: Geolocation Routing

This file provides instructions for AI agents working with this Zuplo example.

## Before You Start

This example is simpler than most Zuplo examples because it doesn't require API key authentication. You can test it immediately after starting the dev server using the `_testCountry` query parameter.

**Note**: Real geolocation detection only works on deployed projects (Zuplo detects country from IP at the edge). Locally, use `_testCountry` to simulate different locations.

## Setup Workflow

### Phase 1: Agent-Executable (Automated)

Run these commands to prepare the local environment:

```bash
# 1. Install dependencies
npm install

# 2. Create environment file
cp env.example .env

# 3. Start dev server
npm run dev
```

The example works immediately with default `https://echo.zuplo.io` backends (an echo service that returns request details as JSON).

### Phase 2: Human-Required (Portal Access) - Optional

**Only needed if user wants to deploy or use real backends.**

Inform the user they can optionally complete these steps in the [Zuplo Portal](https://portal.zuplo.com):

1. **Create/select a Zuplo project** - Required for deployment
2. **Set environment variables** (optional) - Settings → Environment Variables:
   - `API_URL_AMERICAS` - Americas backend URL
   - `API_URL_EUROPE` - Europe backend URL
   - `API_URL_APAC` - Asia-Pacific backend URL
   - `API_URL_DEFAULT` - Fallback backend URL

### Phase 3: Link Local Environment (Interactive) - Optional

**Only needed if user wants to deploy.**

The user must run this command and complete the interactive prompts:

```bash
npx zuplo link
```

### Phase 4: Agent-Executable (Development)

Once running, agents can test immediately:

```bash
# Test with simulated locations
curl "http://localhost:9000/v1/anything?_testCountry=US"
curl "http://localhost:9000/v1/anything?_testCountry=DE"
curl "http://localhost:9000/v1/anything?_testCountry=JP"
curl "http://localhost:9000/v1/anything?_testCountry=XX"
```

## File Modification Guidelines

### Safe to Modify

| File | Purpose | Notes |
|------|---------|-------|
| `modules/geolocation-routing.ts` | Routing logic | Add countries, regions, change mappings |
| `config/routes.oas.json` | API routes | Add/modify endpoints, change handlers |
| `config/policies.json` | Policy config | Add new policies, reorder policy chains |
| `.env` | Local env vars | Add backend URLs |

### Do Not Modify

| File | Reason |
|------|--------|
| `.env.zuplo` | Generated by `zuplo link`, contains auth tokens |
| `zuplo.jsonc` | Project metadata, rarely needs changes |

## Code Patterns

### Adding a Country

```typescript
// In modules/geolocation-routing.ts, add to ROUTING_CONFIG
const ROUTING_CONFIG: Record<string, string> = {
  // ... existing countries ...
  
  // Add new country
  ZA: "europe",  // South Africa routes to Europe
};
```

### Adding a New Region

```typescript
// 1. Add countries to ROUTING_CONFIG
BR: "latam",
AR: "latam",
CL: "latam",
CO: "latam",

// 2. Add case to getBackendUrl()
function getBackendUrl(region: string): string {
  switch (region) {
    // ... existing cases ...
    case "latam":
      return environment.API_URL_LATAM ?? "https://echo.zuplo.io";
    default:
      return environment.API_URL_DEFAULT ?? "https://echo.zuplo.io";
  }
}
```

### Adding Authentication

```json
// 1. Add to config/policies.json
{
  "policies": [
    {
      "name": "api-key-auth",
      "policyType": "api-key-inbound",
      "handler": {
        "export": "ApiKeyInboundPolicy",
        "module": "$import(@zuplo/runtime)"
      }
    },
    {
      "name": "geolocation-routing",
      "policyType": "custom-code-inbound",
      "handler": {
        "export": "default",
        "module": "$import(./modules/geolocation-routing)"
      }
    }
  ]
}
```

```json
// 2. Update routes.oas.json policies
"policies": {
  "inbound": ["api-key-auth", "geolocation-routing"]
}
```

### Adding a Route

```json
// In config/routes.oas.json under "paths"
"/v1/new-endpoint": {
  "get": {
    "operationId": "new-endpoint-get",
    "x-zuplo-route": {
      "corsPolicy": "none",
      "policies": {
        "inbound": ["geolocation-routing"]
      },
      "handler": {
        "export": "urlForwardHandler",
        "module": "$import(@zuplo/runtime)",
        "options": {
          "baseUrl": "${context.custom.backendUrl}"
        }
      }
    }
  }
}
```

## Testing Commands

Use `-i` flag to see response headers:

```bash
# Americas (United States)
curl -i "http://localhost:9000/v1/anything?_testCountry=US"

# Europe (Germany)
curl -i "http://localhost:9000/v1/anything?_testCountry=DE"

# APAC (Japan)
curl -i "http://localhost:9000/v1/anything?_testCountry=JP"

# Global fallback (unknown)
curl -i "http://localhost:9000/v1/anything?_testCountry=XX"

# POST request
curl -i -X POST "http://localhost:9000/v1/anything?_testCountry=GB" \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'
```

Check response headers for routing info:
- `X-Routed-Region` - The region selected (americas, europe, apac, global)
- `X-Detected-Country` - The country code detected or simulated

## Deployment

After all changes are complete and tested:

```bash
zuplo deploy
```

**Note**: For deployed projects, if using real backends, set environment variables in the Zuplo Portal under Settings → Environment Variables.

## Common Issues

| Symptom | Likely Cause | Agent Action |
|---------|--------------|--------------|
| Always routes to global | Country not in ROUTING_CONFIG | Add country code to appropriate region |
| `_testCountry` ignored | Typo in query param | Verify exact spelling `_testCountry` |
| Headers missing | Policy not applied | Check route includes `geolocation-routing` policy |
| Connection refused | Server not running | Run `npm run dev` |
| ENV var undefined | Missing .env | Run `cp env.example .env` |

## User Communication Templates

### Initial Setup Message

> This example is ready to test immediately. I'll set it up:
>
> ```bash
> npm install && cp env.example .env && npm run dev
> ```
>
> You can then test geolocation routing using the `_testCountry` query parameter:
>
> ```bash
> curl -i "http://localhost:9000/v1/anything?_testCountry=DE"
> ```
>
> The response headers will show `X-Routed-Region: europe` and `X-Detected-Country: DE`.

### Ready to Deploy Message

> The example is working locally. To deploy to Zuplo:
>
> 1. Create a project at [portal.zuplo.com](https://portal.zuplo.com) (if you haven't already)
> 2. Run `npx zuplo link` and follow the prompts
> 3. Optionally set `API_URL_AMERICAS`, `API_URL_EUROPE`, `API_URL_APAC`, `API_URL_DEFAULT` in Settings → Environment Variables
> 4. Run `zuplo deploy`
>
> Let me know when you've completed the portal setup.
